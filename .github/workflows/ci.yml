# ============================================
# Streamify — CI Pipeline (Monorepo)
# ============================================
# Runs on every push/PR — lint, build, Docker validation
# Uses Turborepo for workspace-aware builds
# ============================================

name: CI Pipeline

on:
    push:
        branches: [main, develop, master]
    pull_request:
        branches: [main, develop, master]

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

env:
    NODE_VERSION: "20"

jobs:
    # ---- Detect Changed Paths ----
    changes:
        name: Detect Changes
        runs-on: ubuntu-latest
        outputs:
            backend: ${{ steps.filter.outputs.backend }}
            frontend: ${{ steps.filter.outputs.frontend }}
            shared: ${{ steps.filter.outputs.shared }}
            infra: ${{ steps.filter.outputs.infra }}
        steps:
            - uses: actions/checkout@v4
            - uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      backend:
                        - 'apps/backend/**'
                        - 'packages/shared/**'
                      frontend:
                        - 'apps/frontend/**'
                        - 'packages/shared/**'
                      shared:
                        - 'packages/**'
                      infra:
                        - 'infra/**'
                        - 'docker-compose*.yml'

    # ---- Lint & Build (Turborepo) ----
    lint-build:
        name: Lint & Build
        runs-on: ubuntu-latest
        needs: changes
        if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.shared == 'true'
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Lint (Turborepo)
              run: npx turbo lint

            - name: Build (Turborepo)
              run: npx turbo build

    # ---- Docker Build Validation ----
    docker-build:
        name: Docker Build (${{ matrix.service }})
        runs-on: ubuntu-latest
        needs: changes
        if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.infra == 'true'
        strategy:
            matrix:
                include:
                    - service: backend
                      dockerfile: infra/docker/backend.Dockerfile
                    - service: frontend
                      dockerfile: infra/docker/frontend.Dockerfile
        steps:
            - uses: actions/checkout@v4

            - name: Lint Dockerfile
              uses: hadolint/hadolint-action@v3.1.0
              with:
                  dockerfile: ${{ matrix.dockerfile }}

            - name: Build Docker image
              run: |
                  docker build \
                    -f ${{ matrix.dockerfile }} \
                    -t streamify-${{ matrix.service }}:ci \
                    .

            - name: Scan with Trivy
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: streamify-${{ matrix.service }}:ci
                  format: "table"
                  exit-code: "0"
                  severity: "HIGH,CRITICAL"
