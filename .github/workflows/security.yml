# ============================================
# Streamify — Nightly Security Scan
# ============================================
# Runs daily at 2 AM UTC to catch new CVEs
# ============================================

name: Security Scan

on:
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM UTC
  workflow_dispatch: # Allow manual trigger

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}-frontend

jobs:
  # ──────────────────────────────────────────
  # Job 1: NPM Dependency Audit
  # ──────────────────────────────────────────
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [frontend, backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.project }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.project }}
        run: npm ci

      - name: Run npm audit
        working-directory: ${{ matrix.project }}
        run: npm audit --audit-level=high || true
        # '|| true' prevents workflow failure on known vulnerabilities
        # Review audit output manually

  # ──────────────────────────────────────────
  # Job 2: Container Image Scan
  # ──────────────────────────────────────────
  image-scan:
    name: Scan Container Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      security-events: write
    strategy:
      matrix:
        include:
          - service: backend
            image: ghcr.io/${{ github.repository }}-backend:latest
          - service: frontend
            image: ghcr.io/${{ github.repository }}-frontend:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest image
        run: docker pull ${{ matrix.image }} || echo "⚠️ Image not found, skipping scan"

      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.image }}
          format: "sarif"
          output: trivy-nightly-${{ matrix.service }}.sarif
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-nightly-${{ matrix.service }}.sarif
          category: nightly-${{ matrix.service }}
