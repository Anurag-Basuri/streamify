# ============================================
# Streamify â€” Security Scan Pipeline (Monorepo)
# ============================================

name: Security Scan

on:
    schedule:
        - cron: "0 3 * * *" # Daily at 3 AM UTC
    workflow_dispatch:

env:
    REGISTRY: ghcr.io
    IMAGE_PREFIX: ${{ github.repository_owner }}/streamify

permissions:
    contents: read
    security-events: write

jobs:
    # ---- npm Audit ----
    npm-audit:
        name: npm Audit (${{ matrix.workspace }})
        runs-on: ubuntu-latest
        strategy:
            matrix:
                workspace: [apps/backend, apps/frontend]
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20

            - name: Install dependencies
              run: npm ci

            - name: Run audit
              working-directory: ${{ matrix.workspace }}
              run: npm audit --audit-level=moderate || true

    # ---- Container Scan ----
    container-scan:
        name: Trivy Scan (${{ matrix.service }})
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - service: backend
                      image: backend
                    - service: frontend
                      image: frontend
        steps:
            - uses: actions/checkout@v4

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Scan image
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:latest
                  format: "sarif"
                  output: "trivy-${{ matrix.service }}.sarif"
                  severity: "HIGH,CRITICAL"
              continue-on-error: true

            - name: Upload to Security tab
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-${{ matrix.service }}.sarif"
                  category: "trivy-${{ matrix.service }}"
