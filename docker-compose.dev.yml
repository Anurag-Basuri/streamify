# ============================================
# Streamify â€” Docker Compose (Development Overrides)
# ============================================
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#   OR: make dev
# ============================================

services:
    # ---- Backend (Dev mode with hot-reload) ----
    backend:
        build:
            context: .
            dockerfile: infra/docker/backend.Dockerfile
            target: deps
        container_name: streamify-backend-dev
        command: >
            sh -c "cd /app/apps/backend &&
                   npx nodemon -r dotenv/config --experimental-json-modules src/index.js"
        volumes:
            - ./apps/backend/src:/app/apps/backend/src
            - ./packages/shared/src:/app/packages/shared/src
        environment:
            - NODE_ENV=development
            - MONGODB_URL=mongodb://mongo:27017/streamify-dev
            - DB_NAME=streamify-dev
            - REDIS_URL=redis://redis:6379
            - CORS_ORIGIN=http://localhost:5173
        ports:
            - "8000:8000"
            - "9229:9229" # Node.js debugger
        deploy:
            resources: {}

    # ---- Frontend (Vite Dev Server) ----
    frontend:
        build: {}
        image: node:20-alpine
        container_name: streamify-frontend-dev
        working_dir: /app/apps/frontend
        command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
        volumes:
            - ./apps/frontend:/app/apps/frontend
            - ./packages/shared:/app/packages/shared
            - ./package.json:/app/package.json
            - frontend_node_modules:/app/apps/frontend/node_modules
        ports:
            - "5173:5173"
        environment:
            - NODE_ENV=development
        depends_on:
            - backend

    # ---- Mongo Express (DB Management UI) ----
    mongo-express:
        image: mongo-express:latest
        container_name: streamify-mongo-express
        ports:
            - "8081:8081"
        environment:
            - ME_CONFIG_MONGODB_SERVER=mongo
            - ME_CONFIG_MONGODB_PORT=27017
            - ME_CONFIG_BASICAUTH=false
        depends_on:
            mongo:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - streamify

volumes:
    frontend_node_modules:
        driver: local
