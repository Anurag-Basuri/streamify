# ============================================
# Streamify â€” Docker Compose (Development)
# ============================================
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#   OR: make dev
# ============================================
# This file overrides docker-compose.yml for local development:
#   - Backend uses nodemon with source bind-mount for hot-reload
#   - Frontend runs Vite dev server with HMR instead of Nginx
#   - Mongo Express UI available at http://localhost:8081
# ============================================

services:
  # ---- Backend (Dev Mode with Hot Reload) ----
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: deps
    container_name: streamify-backend-dev
    command: >
      sh -c "
        apk add --no-cache ffmpeg curl &&
        npx nodemon --experimental-json-modules src/index.js
      "
    ports:
      - "8000:8000"
      - "9229:9229" # Node.js debugger port
    volumes:
      - ./backend/src:/app/src:delegated
      - ./backend/package.json:/app/package.json
    environment:
      - NODE_ENV=development
    restart: "no"
    deploy:
      resources: {}

  # ---- Frontend (Vite Dev Server with HMR) ----
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: build
    container_name: streamify-frontend-dev
    command: npx vite --host 0.0.0.0 --port 5173
    ports:
      - "5173:5173"
    volumes:
      - ./frontend/src:/app/src:delegated
      - ./frontend/index.html:/app/index.html
      - ./frontend/vite.config.js:/app/vite.config.js
      - ./frontend/tailwind.config.js:/app/tailwind.config.js
      - ./frontend/postcss.config.js:/app/postcss.config.js
    environment:
      - NODE_ENV=development
    depends_on:
      backend:
        condition: service_started
    restart: "no"
    healthcheck:
      disable: true

  # ---- Mongo Express (Database Admin UI) ----
  mongo-express:
    image: mongo-express:latest
    container_name: streamify-mongo-express
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongo
      - ME_CONFIG_MONGODB_PORT=27017
      - ME_CONFIG_BASICAUTH=false
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - streamify
